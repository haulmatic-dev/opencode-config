FROM ubuntu:22.04

RUN apt-get update && apt-get install -y \
    curl git wget unzip gnupg lsb-release ca-certificates \
    build-essential libglib2.0-0 libnss3 libatk1.0-0 libatk-bridge2.0-0 \
    libcups2 libdrm2 libxkbcommon0 libxcomposite1 libxdamage1 \
    libxfixes3 libxrandr2 libgbm1 libasound2 \
    python3 python3-pip python3-venv vim sudo make gcc g++ \
    libssl-dev zlib1g-dev libbz2-dev libreadline-dev \
    libsqlite3-dev libncursesw5-dev xz-utils tk-dev \
    libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev \
    && rm -rf /var/lib/apt/lists/*

RUN curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && \
    apt-get install -y nodejs && rm -rf /var/lib/apt/lists/*

RUN wget -q https://go.dev/dl/go1.21.5.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.21.5.linux-amd64.tar.gz && rm go1.21.5.linux-amd64.tar.gz
ENV PATH=/usr/local/go/bin:$PATH

RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

WORKDIR /home/testuser

COPY --chown=testuser:testuser bin/ /home/testuser/.config/opencode/bin/
COPY --chown=testuser:testuser biome.json .prettierrc opencode.json /home/testuser/.config/opencode/
COPY --chown=testuser:testuser .githooks/ /home/testuser/.config/opencode/.githooks/
COPY --chown=testuser:testuser AGENTS.md /home/testuser/.config/opencode/

RUN mkdir -p /home/testuser/test-project && \
    cd /home/testuser/test-project && \
    git init && \
    chown -R testuser:testuser /home/testuser

USER testuser
WORKDIR /home/testuser/test-project

ENV PATH=/home/testuser/.config/opencode/bin:/usr/local/go/bin:$PATH

RUN echo '#!/bin/bash' > /tmp/test.sh && \
    echo 'set -e' >> /tmp/test.sh && \
    echo 'echo "Testing workspace-init"' >> /tmp/test.sh && \
    echo '/home/testuser/.config/opencode/bin/workspace-init --force' >> /tmp/test.sh && \
    echo 'echo "Done"' >> /tmp/test.sh && \
    chmod +x /tmp/test.sh

CMD ["/bin/bash", "/tmp/test.sh"]

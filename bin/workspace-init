#!/bin/bash

# workspace-init - Project workspace initialization
# Sets up git repo, cass_memory, and beads tracking
# Prerequisite: Run 'opencode-init' first to install system dependencies

set -e

# Determine opencode bin directory (absolute path)
OPENCODE_BIN_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   OpenCode - Workspace Initialization      â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Parse arguments
SKIP_SYSTEM_CHECK=false
FORCE=false
for arg in "$@"; do
  case $arg in
    --skip-system-check)
      SKIP_SYSTEM_CHECK=true
      shift
      ;;
    --force|-f)
      FORCE=true
      shift
      ;;
    --help|-h)
      echo "Initialize project workspace with cass_memory and beads tracking"
      echo ""
      echo "Prerequisite: Run 'opencode-init' first to install system dependencies"
      echo ""
      echo "What it does:"
      echo "  â€¢ Initialize git repository (if missing)"
      echo "  â€¢ Initialize cass_memory (cm init --repo) - REQUIRED"
      echo "  â€¢ Initialize beads task tracking (bd init)"
      echo "  â€¢ Index project with TLDR for code analysis"
      echo "  â€¢ Copy Biome linting configuration"
      echo "  â€¢ Copy Prettier formatting configuration"
      echo "  â€¢ Copy opencode configuration"
      echo "  â€¢ Install pre-commit git hook (UBS static analysis)"
      echo "  â€¢ Install Husky & lint-staged (if package.json exists)"
      echo "  â€¢ Configure git merge driver for beads"
      echo "  â€¢ Install beads git hooks"
      echo "  â€¢ Install npm dependencies (if package.json exists)"
      echo ""
      echo "Usage: workspace-init [--skip-system-check] [--force]"
      exit 0
      ;;
  esac
done

# Check system prerequisites
if [ "$SKIP_SYSTEM_CHECK" = false ]; then
  MISSING_TOOLS=false

  if ! command -v cm &> /dev/null; then
    echo -e "${RED}âœ— Error:${NC} cass_memory (cm) not found"
    echo "  Run 'opencode-init' first to install system dependencies"
    MISSING_TOOLS=true
  fi

  if ! command -v bd &> /dev/null; then
    echo -e "${RED}âœ— Error:${NC} Beads CLI (bd) not found"
    echo "  Run 'opencode-init' first to install system dependencies"
    MISSING_TOOLS=true
  fi

  if [ "$MISSING_TOOLS" = true ]; then
    exit 1
  fi
fi

# Check workspace state
HAS_GIT=false
HAS_CASS_INIT=false
HAS_BEADS_INIT=false

[ -d ".git" ] && HAS_GIT=true
[ -d ".cass" ] && HAS_CASS_INIT=true
[ -d ".beads" ] && HAS_BEADS_INIT=true

# Show status
echo
echo -e "${YELLOW}ðŸ“Š Workspace Status:${NC}"
echo -e "  Git:        $([ "$HAS_GIT" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "â—‹")"
echo -e "  cass_memory: $([ "$HAS_CASS_INIT" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "â—‹")"
echo -e "  Beads:      $([ "$HAS_BEADS_INIT" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "â—‹")"

# Exit if everything is set up
if [ "$HAS_GIT" = true ] && [ "$HAS_CASS_INIT" = true ] && [ "$HAS_BEADS_INIT" = true ]; then
  echo
  echo -e "${GREEN}âœ“ Workspace ready${NC}"
  exit 0
fi

# Non-interactive check (skip if --force flag is set)
if [ ! -t 0 ] && [ "$FORCE" = false ]; then
  echo
  echo -e "${YELLOW}â„¹${NC}  Non-interactive terminal detected"
  echo "  Use --force flag to run with defaults, or run in interactive terminal"
  exit 0
fi

# Ask for confirmation (skip if --force flag is set)
if [ "$FORCE" = true ]; then
  echo
  echo -e "${BLUE}ðŸš€${NC} Running in force mode with defaults"
else
  echo
  echo -en "${YELLOW}â“${NC}  Set up workspace? [y/N]: "
  read -r response

  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}Skipped${NC}"
    exit 0
  fi
fi

COMPLETED=()

# Helper function for prompts (returns 0 for yes, 1 for no)
prompt_yes() {
  local prompt="$1"
  if [ "$FORCE" = true ]; then
    return 0
  fi
  echo -n "$prompt"
  read -r r
  if [[ -z "$r" ]] || [[ "$r" =~ ^[Yy]$ ]]; then
    return 0
  else
    return 1
  fi
}

# Git initialization
if [ "$HAS_GIT" = false ]; then
  echo
  echo -e "${BLUE}Step 1: Git Repository${NC}"
  if prompt_yes "  Initialize git? [Y/n]: "; then
    if command -v git &> /dev/null; then
      git init -q
      echo -e "  ${GREEN}âœ“${NC} Initialized"
      COMPLETED+=("git")
    else
      echo -e "  ${RED}âœ—${NC} Git not found"
      exit 1
    fi
  fi
fi

# cass_memory initialization (REQUIRED)
if [ "$HAS_CASS_INIT" = false ]; then
  echo
  echo -e "${BLUE}Step 2: cass_memory (REQUIRED)${NC}"
  if [ ! -d ".git" ]; then
    echo -e "  ${RED}âœ—${NC} No git repository (run Step 1 first)"
    exit 1
  fi

  echo "  This will initialize cass_memory for this project"
  if prompt_yes "  Initialize cass_memory? [Y/n]: "; then
    if command -v cm &> /dev/null; then
      cm init --repo
      echo -e "  ${GREEN}âœ“${NC} Initialized"
      COMPLETED+=("cass_memory")
    else
      echo -e "  ${RED}âœ—${NC} cass_memory (cm) not found"
      exit 1
    fi
  else
    echo -e "  ${RED}âœ—${NC} cass_memory is required for opencode"
    exit 1
  fi
fi

# Beads initialization
if [ "$HAS_BEADS_INIT" = false ]; then
  echo
  echo -e "${BLUE}Step 3: Beads Tracking${NC}"
  if [ ! -d ".git" ]; then
    echo -e "  ${RED}âœ—${NC} No git repository (run Step 1 first)"
    exit 1
  else
    if prompt_yes "  Initialize beads? [Y/n]: "; then
      bd init
      # Remove AGENTS.md files created by bd init (not needed - inherited from ~/.config/opencode/AGENTS.md)
      rm -f AGENTS.md @AGENTS.md 2>/dev/null || true
      echo -e "  ${GREEN}âœ“${NC} Initialized"
      COMPLETED+=("beads")
    fi
  fi
fi

# TLDR initialization (REQUIRED for code analysis)
echo
echo -e "${BLUE}Step 4: TLDR Code Indexing (REQUIRED)${NC}"
if command -v tldr &> /dev/null; then
  echo "  TLDR provides semantic search, impact analysis, and code context"
  if [ -d ".tldr" ]; then
    echo -e "  ${GREEN}âœ“${NC} TLDR already indexed"
  else
    if prompt_yes "  Index project with TLDR? [Y/n]: "; then
      if tldr warm . 2>/dev/null; then
        echo -e "  ${GREEN}âœ“${NC} TLDR indexed"
        COMPLETED+=("tldr")
      else
        echo -e "  ${YELLOW}âš ${NC} TLDR indexing failed (tldr warm .)"
      fi
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} TLDR not found (run 'opencode-init' first)"
fi

# Copy Biome configuration
echo
echo -e "${BLUE}Step 5: Biome Linting Configuration${NC}"
if [ -f "$OPENCODE_BIN_DIR/../biome.json" ]; then
  if [ -f "biome.json" ]; then
    echo -e "  ${GREEN}âœ“${NC} biome.json already exists"
  else
    if prompt_yes "  Copy biome.json? [Y/n]: "; then
      cp "$OPENCODE_BIN_DIR/../biome.json" .
      echo -e "  ${GREEN}âœ“${NC} biome.json copied"
      COMPLETED+=("biome")
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} biome.json not found in ~/.config/opencode/"
fi

# Copy Prettier configuration
echo
echo -e "${BLUE}Step 6: Prettier Formatting Configuration${NC}"
if [ -f "$OPENCODE_BIN_DIR/../.prettierrc" ]; then
  if [ -f ".prettierrc" ]; then
    echo -e "  ${GREEN}âœ“${NC} .prettierrc already exists"
  else
    if prompt_yes "  Copy .prettierrc? [Y/n]: "; then
      cp "$OPENCODE_BIN_DIR/../.prettierrc" .
      echo -e "  ${GREEN}âœ“${NC} .prettierrc copied"
      COMPLETED+=("prettier")
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} .prettierrc not found in ~/.config/opencode/"
fi

# Copy opencode configuration
echo
echo -e "${BLUE}Step 7: opencode Configuration${NC}"
if [ -f "$OPENCODE_BIN_DIR/../opencode.json" ]; then
  if [ -f "opencode.json" ]; then
    echo -e "  ${GREEN}âœ“${NC} opencode.json already exists"
  else
    if prompt_yes "  Copy opencode.json? [Y/n]: "; then
      cp "$OPENCODE_BIN_DIR/../opencode.json" .
      echo -e "  ${GREEN}âœ“${NC} opencode.json copied"
      COMPLETED+=("opencode")
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} opencode.json not found in ~/.config/opencode/"
fi

# Install git hooks (pre-commit)
echo
echo -e "${BLUE}Step 8: Git Hooks (Pre-commit)${NC}"
if [ -f "$OPENCODE_BIN_DIR/../.githooks/pre-commit" ]; then
  if [ -f ".git/hooks/pre-commit" ]; then
    echo -e "  ${GREEN}âœ“${NC} pre-commit hook already installed"
  else
    if prompt_yes "  Install pre-commit hook (UBS static analysis)? [Y/n]: "; then
      mkdir -p .git/hooks
      cp "$OPENCODE_BIN_DIR/../.githooks/pre-commit" .git/hooks/pre-commit
      chmod +x .git/hooks/pre-commit
      echo -e "  ${GREEN}âœ“${NC} pre-commit hook installed"
      COMPLETED+=("git-hooks")
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} pre-commit hook not found in ~/.config/opencode/.githooks/"
fi

# Install Husky and lint-staged
echo
echo -e "${BLUE}Step 9: Husky & Lint-staged (Git Hook Framework)${NC}"
if [ -f "package.json" ]; then
  if [ -d ".husky" ]; then
    echo -e "  ${GREEN}âœ“${NC} Husky already configured"
  else
    echo "  Husky enables pre-commit lint/format checks"
    if prompt_yes "  Install Husky? [Y/n]: "; then
      if npx husky install 2>/dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Husky installed"
        COMPLETED+=("husky")
      else
        echo -e "  ${YELLOW}âš ${NC} Husky install failed (npm install may be needed first)"
      fi
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} No package.json found (skipping Husky)"
fi

# Configure git merge driver for Beads
echo
echo -e "${BLUE}Step 10: Git Merge Driver for Beads${NC}"
if [ -d ".git" ]; then
  CURRENT_DRIVER=$(git config --get merge.beads.driver 2>/dev/null || echo "")
  if [ -n "$CURRENT_DRIVER" ]; then
    echo -e "  ${GREEN}âœ“${NC} Merge driver already configured"
  else
    if prompt_yes "  Configure git merge driver for beads? [Y/n]: "; then
      git config merge.beads.driver "bd merge %A %O %A %B"
      echo -e "  ${GREEN}âœ“${NC} Merge driver configured"
      COMPLETED+=("merge-driver")
    fi
  fi
fi

# Install Beads git hooks
echo
echo -e "${BLUE}Step 11: Beads Git Hooks${NC}"
if command -v bd &> /dev/null && [ -d ".beads" ]; then
  if prompt_yes "  Install beads git hooks? [Y/n]: "; then
    if bd hooks install 2>/dev/null; then
      echo -e "  ${GREEN}âœ“${NC} Beads hooks installed"
      COMPLETED+=("beads-hooks")
    else
      echo -e "  ${YELLOW}âš ${NC} Beads hooks install failed"
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} Beads not initialized (run Step 3 first)"
fi

# npm install (if package.json exists)
echo
echo -e "${BLUE}Step 12: Install Node Dependencies${NC}"
if [ -f "package.json" ]; then
  if [ -d "node_modules" ]; then
    echo -e "  ${GREEN}âœ“${NC} Dependencies already installed"
  else
    echo "  Run npm install to install project dependencies?"
    if prompt_yes "  Install? [Y/n]: "; then
      if npm install 2>/dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Dependencies installed"
        COMPLETED+=("npm-install")
      else
        echo -e "  ${YELLOW}âš ${NC} npm install failed"
      fi
    fi
  fi
else
  echo -e "  ${YELLOW}â—‹${NC} No package.json found (skipping)"
fi

# Summary
echo
if [ ${#COMPLETED[@]} -gt 0 ]; then
  echo -e "${GREEN}âœ“ Done:${NC}"
  for item in "${COMPLETED[@]}"; do
    echo "  â€¢ $item"
  done
else
  echo -e "${YELLOW}No changes${NC}"
fi

if [ -d ".beads" ]; then
  echo
  echo -e "${BLUE}Next:${NC}"
  echo "  bd create \"task\"  # Create a task"
  echo "  cm context \"task description\"  # Get context from cass_memory"
  echo "  npm run lint  # Run Biome linting"
  echo "  npm run format  # Format code with Prettier"
fi

echo

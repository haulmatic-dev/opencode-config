#!/bin/bash
# opencode-init - System-wide setup for opencode
# Installs cass_memory (cm), beads CLI (bd), beads viewer (bv), osgrep, and configures PATH
# Run once per machine

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect shell and config file
if [ -n "$ZSH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.zshrc"
  SHELL_NAME="zsh"
elif [ -n "$BASH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.bashrc"
  SHELL_NAME="bash"
else
  SHELL_CONFIG="$HOME/.profile"
  SHELL_NAME="sh"
fi

# Parse arguments
QUIET=false
for arg in "$@"; do
  case $arg in
    --help|-h)
      echo "System-wide setup for opencode"
      echo ""
      echo "Installs:"
      echo "  â€¢ cass_memory (cm) - Evidence-based learning system"
      echo "  â€¢ beads CLI (bd) - Task tracking"
      echo "  â€¢ beads viewer (bv) - Terminal UI for browsing tasks"
      echo "  â€¢ osgrep - Semantic code search"
      echo "  â€¢ Configures PATH for ~/.config/opencode/bin"
      echo ""
      echo "Usage: opencode-init [--quiet]"
      exit 0
      ;;
    --quiet|-q)
      QUIET=true
      shift
      ;;
  esac
done

# Banner
if [ "$QUIET" = false ]; then
  echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${BLUE}â•‘   OpenCode - System-Wide Setup (opencode-init)â•‘${NC}"
  echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo
  echo -e "${BLUE}ðŸ“‹ System Information:${NC}"
  echo "  OS:        $(uname -s)"
  echo "  Shell:     $SHELL_NAME"
  echo "  Config:    $SHELL_CONFIG"
  echo
fi

# Check prerequisites
echo -e "${BLUE}ðŸ“Š Checking Prerequisites:${NC}"

HAS_GO=false
HAS_NODE=false
PATH_CONFIGURED=false
HAS_CM=false
HAS_BD=false
HAS_OSGREP=false
HAS_BV=false
HAS_GPTCACHE=false
HAS_MCP_AGENT_MAIL=false

command -v cm &> /dev/null && HAS_CM=true
command -v bd &> /dev/null && HAS_BD=true
command -v osgrep &> /dev/null && HAS_OSGREP=true
command -v bv &> /dev/null && HAS_BV=true
command -v python3 &> /dev/null && HAS_PYTHON3=true
[ -d "$HOME/.gptcache" ] && HAS_GPTCACHE=true
[ -d "$HOME/.mcp_agent_mail" ] && HAS_MCP_AGENT_MAIL=true

echo
echo -e "${BLUE}ðŸ“Š Current Status:${NC}"
echo -e "  cass_memory (cm):      $([ "$HAS_CM" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(cm --version 2>/dev/null || echo "not installed")"
echo -e "  Beads CLI (bd):       $([ "$HAS_BD" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(bd --version 2>/dev/null | head -1 || echo "not installed")"
echo -e "  Osgrep:               $([ "$HAS_OSGREP" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(osgrep --version 2>/dev/null || echo "not installed")"
echo -e "  Beads Viewer (bv):    $([ "$HAS_BV" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(bv --version 2>/dev/null || echo "not installed")"
echo -e "  MCP Agent Mail:        $([ "$HAS_MCP_AGENT_MAIL" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $([ -d "$HOME/.mcp_agent_mail" ] && echo "installed" || echo "not installed")"

# Step 8: Install GPTCache
if [ "$HAS_GPTCACHE" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 8: Install GPTCache (Prompt Caching)${NC}"
    echo "  GPTCache reduces LLM costs by caching prompt/response pairs"
    echo "  Local storage (no Redis needed) - perfect for M1 MacBook Air with 8GB RAM"
    echo -n "  Install GPTCache? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping GPTCache installation"
    else
      # Check for Python 3.10+ (GPTCache requirement)
      if ! command -v python3 &> /dev/null; then
        echo -e "  ${RED}âœ—${NC} Python 3 not found"
        echo "  Install Python 3.10+ or ensure it's in PATH"
        exit 1
      fi

      # Install GPTCache
      echo "  Installing GPTCache with pip..."
      pip3 install 'gptcache' 'numpy<2'
      if [ $? -ne 0 ]; then
        echo -e "  ${RED}âœ—${NC} Failed to install GPTCache"
        exit 1
      fi

      # Check Python version
      PYTHON_VERSION=$(python3 --version 2>&1 | awk '{print $2}')
      PYTHON_MAJOR=$(echo $PYTHON_VERSION | cut -d. -f1)
      PYTHON_MINOR=$(echo $PYTHON_VERSION | cut -d. -f2)
      
      if [ "$PYTHON_MAJOR" -lt 3 ] || ([ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -lt 10 ]); then
        echo -e "  ${YELLOW}âš ${NC}  GPTCache requires Python 3.10+"
        echo "  Current version: $PYTHON_VERSION"
        echo "  Upgrade with: pyenv install 3.10 && pyenv local 3.10"
      fi

      echo -e "  ${GREEN}âœ“${NC} GPTCache installed: $(gptcache_server --version 2>/dev/null || echo "gptcache_server")"
      COMPLETED_STEPS+=("GPTCache installed")
      HAS_GPTCACHE=true

      # Start GPTCache server
      if [ "$QUIET" = false ]; then
        echo
        echo -n "  Start GPTCache server now? [Y/n]: "
        read -r m
        if [[ -z "$m" ]] || [[ "$m" =~ ^[Yy]$ ]]; then
          echo "  Starting GPTCache server..."
          $HOME/.config/opencode/bin/gptcache-wrapper start
          echo -e "  ${GREEN}âœ“${NC} GPTCache server started"
          COMPLETED_STEPS+=("GPTCache server started")
        else
          echo "  Run later: $HOME/.config/opencode/bin/gptcache-wrapper start"
        fi
      else
        # Quiet mode - auto-start
        $HOME/.config/opencode/bin/gptcache-wrapper start
        COMPLETED_STEPS+=("GPTCache server started")
      fi
    else
      pip3 install 'gptcache' 'numpy<2'
      if [ $? -ne 0 ]; then
        echo -e "  ${RED}âœ—${NC} Failed to install GPTCache"
        exit 1
      fi

      # Create symlink to PATH
      if command -v python3 &> /dev/null; then
        PYTHON_PATH=$(command -v python3 &> /dev/null | xargs dirname 2>/dev/null | xargs dirname 2>/dev/null)
        if [[ ":$PATH:" != *":$PYTHON_PATH:"* ]]; then
          echo 'export PATH="'$PYTHON_PATH':$PATH"' >> "$SHELL_CONFIG"
          echo -e "  ${GREEN}âœ“${NC} Added Python to PATH"
        fi
      fi

      echo -e "  ${GREEN}âœ“${NC} GPTCache installed: $(gptcache --version 2>/dev/null || echo "gptcache")"
      COMPLETED_STEPS+=("GPTCache installed")
      HAS_GPTCACHE=true

      # Start GPTCache server
      if [ "$QUIET" = false ]; then
        echo
        echo -n "  Start GPTCache server now? [Y/n]: "
        read -r m
        if [[ -z "$m" ]] || [[ "$m" =~ ^[Yy]$ ]]; then
          echo "  Starting GPTCache server..."
          $HOME/.config/opencode/bin/gptcache-wrapper start
          echo -e "  ${GREEN}âœ“${NC} GPTCache server started"
          COMPLETED_STEPS+=("GPTCache server started")
        else
          echo "  Run later: $HOME/.config/opencode/bin/gptcache-wrapper start"
          echo -e "  ${YELLOW}â„¹${NC}  Or run: gptcache server --storage local"
        fi
      else
        # Quiet mode - auto-start
        $HOME/.config/opencode/bin/gptcache-wrapper start
        COMPLETED_STEPS+=("GPTCache server started")
      fi
    fi
  else
    pip3 install gptcache
    # Symlink if needed
    if command -v python3 &> /dev/null; then
      PYTHON_PATH=$(command -v python3 &> /dev/null | xargs dirname 2>/dev/null | xargs dirname 2>/dev/null)
      if [[ ":$PATH:" != *":$PYTHON_PATH:"* ]]; then
        echo 'export PATH="'$PYTHON_PATH':$PATH"' >> "$SHELL_CONFIG"
      fi
    fi
    COMPLETED_STEPS+=("GPTCache installed")
    COMPLETED_STEPS+=("GPTCache server started")
    HAS_GPTCACHE=true
  fi
fi
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${GREEN}âœ“ All tools already installed and configured!${NC}"
  fi
  exit 0
fi

# Non-interactive check
if [ ! -t 0 ] && [ "$QUIET" = false ]; then
  echo
  echo -e "${YELLOW}â„¹${NC}  Non-interactive terminal detected"
  echo "  Run with --quiet flag for automated setup"
  exit 0
fi

# Ask for confirmation
if [ "$QUIET" = false ]; then
  echo
  echo -en "${YELLOW}â“${NC}  Would you like to set up your opencode environment? [y/N]: "
  read -r response

  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}Skipped${NC}"
    exit 0
  fi
fi

COMPLETED_STEPS=()

# Detect OS for package manager
OS="$(uname -s)"
if [ "$OS" = "Darwin" ]; then
  PACKAGE_MANAGER="homebrew"
elif [ "$OS" = "Linux" ]; then
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    if [ "$ID" = "ubuntu" ] || [ "$ID" = "debian" ]; then
      PACKAGE_MANAGER="apt"
    else
      PACKAGE_MANAGER="unknown"
    fi
  else
    PACKAGE_MANAGER="unknown"
  fi
else
  PACKAGE_MANAGER="unknown"
fi

# Step 1: Configure PATH
if [ "$PATH_CONFIGURED" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 1: Configure PATH${NC}"
    echo -n "  Add ~/.config/opencode/bin to $SHELL_CONFIG? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping PATH configuration"
    else
      echo 'export PATH="$HOME/.config/opencode/bin:$PATH"' >> "$SHELL_CONFIG"
      export PATH="$HOME/.config/opencode/bin:$PATH"
      echo -e "  ${GREEN}âœ“${NC} Added to $SHELL_CONFIG"
      echo -e "  ${YELLOW}âš ï¸${NC}  Run 'source $SHELL_CONFIG' or start a new terminal to apply changes"
      COMPLETED_STEPS+=("PATH configured")
      PATH_CONFIGURED=true
    fi
  else
    echo 'export PATH="$HOME/.config/opencode/bin:$PATH"' >> "$SHELL_CONFIG"
    export PATH="$HOME/.config/opencode/bin:$PATH"
    COMPLETED_STEPS+=("PATH configured")
    PATH_CONFIGURED=true
  fi
fi

# Step 2: Install Go (if needed)
if [ "$HAS_GO" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 2: Install Go${NC}"
    if [ "$PACKAGE_MANAGER" = "homebrew" ]; then
      echo "  OS detected: macOS"
      echo "  This will run: brew install go"
      echo -n "  Install Go via Homebrew? [Y/n]: "
      read -r r
      if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
        echo "  Skipping Go installation"
        echo -e "  ${RED}âœ—${NC} Go is required for Beads CLI"
        echo "  Install Go from: https://golang.org/dl/"
        exit 1
      else
        brew install go
        echo -e "  ${GREEN}âœ“${NC} Go installed: $(go version)"
        COMPLETED_STEPS+=("Go installed")
        HAS_GO=true
      fi
    elif [ "$PACKAGE_MANAGER" = "apt" ]; then
      echo "  OS detected: Ubuntu/Debian"
      echo "  This will run: sudo apt-get update && sudo apt-get install -y golang-go"
      echo -n "  Install Go via apt? [Y/n]: "
      read -r r
      if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
        echo "  Skipping Go installation"
        echo -e "  ${RED}âœ—${NC} Go is required for Beads CLI"
        echo "  Install Go from: https://golang.org/dl/"
        exit 1
      else
        sudo apt-get update
        sudo apt-get install -y golang-go
        echo -e "  ${GREEN}âœ“${NC} Go installed: $(go version)"
        COMPLETED_STEPS+=("Go installed")
        HAS_GO=true
      fi
    else
      echo -e "  ${RED}âœ—${NC} Go not found"
      echo "  Unsupported OS/package manager: $PACKAGE_MANAGER"
      echo "  Install Go from: https://golang.org/dl/"
      exit 1
    fi
  else
    # Quiet mode - auto-install Go
    if [ "$PACKAGE_MANAGER" = "homebrew" ]; then
      brew install go
      COMPLETED_STEPS+=("Go installed")
      HAS_GO=true
    elif [ "$PACKAGE_MANAGER" = "apt" ]; then
      sudo apt-get update
      sudo apt-get install -y golang-go
      COMPLETED_STEPS+=("Go installed")
      HAS_GO=true
    else
      echo -e "  ${RED}âœ—${NC} Go not found and cannot auto-install on this OS"
      exit 1
    fi
  fi
fi

# Step 3: Install cass_memory (cm)
if [ "$HAS_CM" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 3: Install cass_memory (cm)${NC}"
    echo "  This will run: curl -fsSL https://raw.githubusercontent.com/Dicklesworthstone/cass_memory_system/main/install.sh | bash -s -- --easy-mode --verify"
    echo -n "  Install cass_memory? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping cass_memory installation"
      echo -e "  ${RED}âœ—${NC} cass_memory is required for opencode"
      exit 1
    else
      curl -fsSL https://raw.githubusercontent.com/Dicklesworthstone/cass_memory_system/main/install.sh | bash -s -- --easy-mode --verify

      if command -v cm &> /dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Installed: $(cm --version 2>/dev/null || echo "cm")"
        COMPLETED_STEPS+=("cass_memory installed")
        HAS_CM=true
      else
        echo -e "  ${RED}âœ—${NC} Installation failed"
        exit 1
      fi
    fi
  else
    curl -fsSL https://raw.githubusercontent.com/Dicklesworthstone/cass_memory_system/main/install.sh | bash -s -- --easy-mode --verify
    if command -v cm &> /dev/null; then
      COMPLETED_STEPS+=("cass_memory installed")
      HAS_CM=true
    else
      echo -e "  ${RED}âœ—${NC} cass_memory installation failed"
      exit 1
    fi
  fi
fi

# Step 4: Install beads CLI
if [ "$HAS_BD" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 4: Install Beads CLI${NC}"
    if [ "$HAS_GO" = false ]; then
      echo -e "  ${RED}âœ—${NC} Go not found"
      echo "  Install Go from: https://golang.org/dl/"
      exit 1
    fi
    echo "  This will run: go install github.com/steveyegge/beads/cmd/bd@latest"
    echo -n "  Install beads CLI? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping beads installation"
    else
      go install github.com/steveyegge/beads/cmd/bd@latest

      # Add go/bin to PATH if not already there
      if [[ ":$PATH:" != *":$HOME/go/bin:"* ]]; then
        echo 'export PATH="$HOME/go/bin:$PATH"' >> "$SHELL_CONFIG"
        export PATH="$HOME/go/bin:$PATH"
      fi

      if command -v bd &> /dev/null; then
        BD_VERSION=$(bd --version 2>&1 | head -1)
        echo -e "  ${GREEN}âœ“${NC} Installed: $BD_VERSION"
        COMPLETED_STEPS+=("Beads CLI installed")
        HAS_BD=true
      else
        echo -e "  ${RED}âœ—${NC} Installation failed. Check that \$HOME/go/bin is in PATH"
        exit 1
      fi
    fi
  else
    go install github.com/steveyegge/beads/cmd/bd@latest
    if [[ ":$PATH:" != *":$HOME/go/bin:"* ]]; then
      echo 'export PATH="$HOME/go/bin:$PATH"' >> "$SHELL_CONFIG"
      export PATH="$HOME/go/bin:$PATH"
    fi
    COMPLETED_STEPS+=("Beads CLI installed")
    HAS_BD=true
  fi
fi

# Step 5: Install osgrep
if [ "$HAS_OSGREP" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 5: Install Osgrep (Semantic Search)${NC}"
    if [ "$HAS_NODE" = false ]; then
      echo -e "  ${RED}âœ—${NC} Node.js not found"
      echo "  Install Node.js from: https://nodejs.org/"
      exit 1
    fi
    echo "  This will run: npm install -g osgrep"
    echo "  (Downloads ~150MB of embedding models)"
    echo -n "  Install osgrep? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping osgrep installation"
    else
      npm install -g osgrep

      if command -v osgrep &> /dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Installed: $(osgrep --version)"
        COMPLETED_STEPS+=("Osgrep installed")
        HAS_OSGREP=true

        # Optionally run osgrep setup to download models
        if [ "$QUIET" = false ]; then
          echo
          echo -n "  Download embedding models now (~150MB)? [Y/n]: "
          read -r m
          if [[ -z "$m" ]] || [[ "$m" =~ ^[Yy]$ ]]; then
            echo "  Downloading models..."
            osgrep setup
            echo -e "  ${GREEN}âœ“${NC} Models downloaded"
          else
            echo "  Run 'osgrep setup' later to download models"
          fi
        fi
      else
        echo -e "  ${RED}âœ—${NC} Installation failed"
        exit 1
      fi
    fi
  else
    npm install -g osgrep
    COMPLETED_STEPS+=("Osgrep installed")
    HAS_OSGREP=true
  fi
fi

# Step 6: Install beads viewer (bv)
if [ "$HAS_BV" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 6: Install Beads Viewer (Terminal UI)${NC}"
    echo "  This downloads and installs beads viewer from GitHub"
    echo "  Source: https://github.com/Dicklesworthstone/beads_viewer"
    echo -n "  Install beads viewer? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping beads viewer installation"
    else
      curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/beads_viewer/main/install.sh" | bash

      if command -v bv &> /dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Installed: $(bv --version 2>/dev/null || echo "bv")"
        COMPLETED_STEPS+=("Beads Viewer installed")
        HAS_BV=true
      else
        echo -e "  ${YELLOW}âš ï¸${NC}  Installation may have failed. Check ~/.local/bin"
      fi
    fi
  else
    curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/beads_viewer/main/install.sh" | bash
    COMPLETED_STEPS+=("Beads Viewer installed")
    HAS_BV=true
  fi
fi

# Summary
if [ "$QUIET" = false ]; then

# Step 7: Install MCP Agent Mail
if [ "$HAS_MCP_AGENT_MAIL" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 7: Install MCP Agent Mail (REQUIRED)${NC}"
    echo "  MCP Agent Mail enables agent-to-agent communication and coordination"
    echo "  Source: https://github.com/Dicklesworthstone/mcp_agent_mail"
    echo "  Requires: Python 3.14+, uv"
    echo -n "  Install MCP Agent Mail? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo -e "  ${RED}âœ—${NC} MCP Agent Mail is REQUIRED for opencode"
      exit 1
    fi
      echo -e "  ${GREEN}âœ“${NC} Repository cloned"

      # Create .env file
      echo "  Creating configuration..."
      cat > "$HOME/.mcp_agent_mail/.env" << 'EOF'
STORAGE_ROOT=$HOME/.mcp_agent_mail/storage
DATABASE_URL=sqlite+aiosqlite:////$HOME/.mcp_agent_mail/storage/mcp.db
HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED=true
HTTP_PORT=8765
EOF
      echo -e "  ${GREEN}âœ“${NC} Configuration created"

      # Install dependencies with uv
      if ! command -v uv &> /dev/null; then
        echo -e "  ${RED}âœ—${NC} uv not found"
        echo "  Install uv: curl -LsSf https://astral.sh/uv/install.sh | sh"
        exit 1
      fi

      # Check for Python 3.14
      HAS_PYTHON314=false
      uv python list 2>/dev/null | grep -q "cpython-3.14" && HAS_PYTHON314=true

      if [ "$HAS_PYTHON314" = false ]; then
        echo "  Installing Python 3.14 with uv..."
        uv python install 3.14
        if [ $? -ne 0 ]; then
          echo -e "  ${RED}âœ—${NC} Failed to install Python 3.14"
          exit 1
        fi
        echo -e "  ${GREEN}âœ“${NC} Python 3.14 installed"
      fi
        echo -e "  ${GREEN}âœ“${NC} Python 3.14 installed"
      fi

      echo "  Installing dependencies..."
      cd "$HOME/.mcp_agent_mail"
      uv sync --python 3.14
      if [ $? -ne 0 ]; then
        echo -e "  ${RED}âœ—${NC} Failed to install dependencies"
        exit 1
      fi
      echo -e "  ${GREEN}âœ“${NC} Dependencies installed"

      # Start server
      if [ "$QUIET" = false ]; then
        echo
        echo -n "  Start MCP Agent Mail server now? [Y/n]: "
        read -r m
        if [[ -z "$m" ]] || [[ "$m" =~ ^[Yy]$ ]]; then
          echo "  Starting MCP Agent Mail server..."
          HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED=true uv run python -m mcp_agent_mail.http --host 127.0.0.1 --port 8765 > "$HOME/.mcp_agent_mail/server.log" 2>&1 &
          echo $! > "$HOME/.mcp_agent_mail/.mcp-agent-mail.pid"
          echo -e "  ${GREEN}âœ“${NC} Server started (http://127.0.0.1:8765)"

          # Wait for server to be ready
          sleep 3
          if curl -s http://127.0.0.1:8765/health/readiness > /dev/null 2>&1; then
            echo -e "  ${GREEN}âœ“${NC} Server is healthy and ready"
          else
            echo -e "  ${YELLOW}âš ${NC}  Server may not be ready. Check $HOME/.mcp_agent_mail/server.log"
          fi
        else
          echo "  Run later: cd ~/.mcp_agent_mail && HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED=true uv run python -m mcp_agent_mail.http --host 127.0.0.1 --port 8765 &"
        fi
      else
        # Quiet mode - start automatically
        cd "$HOME/.mcp_agent_mail"
        HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED=true uv run python -m mcp_agent_mail.http --host 127.0.0.1 --port 8765 > "$HOME/.mcp_agent_mail/server.log" 2>&1 &
        echo $! > "$HOME/.mcp_agent_mail/.mcp-agent-mail.pid"
      fi

      COMPLETED_STEPS+=("MCP Agent Mail installed")
      HAS_MCP_AGENT_MAIL=true
    fi
  else
    # Quiet mode
    git clone https://github.com/Dicklesworthstone/mcp_agent_mail.git "$HOME/.mcp_agent_mail"
    cat > "$HOME/.mcp_agent_mail/.env" << 'EOF'
STORAGE_ROOT=$HOME/.mcp_agent_mail/storage
DATABASE_URL=sqlite+aiosqlite:////$HOME/.mcp_agent_mail/storage/mcp.db
HTTP_ALLOW_LOCALHOST_UNAUTHENTICATED=true
HTTP_PORT=8765
EOF
    cd "$HOME/.mcp_agent_mail"
    uv sync --python 3.14
    COMPLETED_STEPS+=("MCP Agent Mail installed")
    HAS_MCP_AGENT_MAIL=true
  fi
fi

echo
echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘   Setup Complete!                                     â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo

  if [ ${#COMPLETED_STEPS[@]} -gt 0 ]; then
    echo -e "${GREEN}âœ“ Completed:${NC}"
    for step in "${COMPLETED_STEPS[@]}"; do
      echo "  â€¢ $step"
    done
    echo
  fi

  if [ "$PATH_CONFIGURED" = true ]; then
    echo -e "${YELLOW}âš ï¸${NC}  Important:"
    echo "  Source your shell configuration to apply PATH changes:"
    echo "    source $SHELL_CONFIG"
    echo "  Or start a new terminal window"
    echo
  fi

  echo -e "${BLUE}Next Steps:${NC}"
  echo "  1. Source your shell config or start a new terminal"
  echo "  2. Run 'workspace-init' in your project directory to set up task tracking"
  echo "  3. Run 'osgrep setup' if you didn't download models yet"
  echo
  echo -e "${BLUE}Quick Start:${NC}"
  echo "  cd /path/to/your/project"
  echo "  workspace-init"
  echo
fi

exit 0

#!/bin/bash
# opencode-init - System-wide setup for opencode
# Installs cass_memory (cm), beads CLI (bd), beads viewer (bv), osgrep, and configures PATH
# Run once per machine

set -e

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Detect shell and config file
if [ -n "$ZSH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.zshrc"
  SHELL_NAME="zsh"
elif [ -n "$BASH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.bashrc"
  SHELL_NAME="bash"
else
  SHELL_CONFIG="$HOME/.profile"
  SHELL_NAME="sh"
fi

# Parse arguments
QUIET=false
for arg in "$@"; do
  case $arg in
    --help|-h)
      echo "System-wide setup for opencode"
      echo ""
      echo "Installs:"
      echo "  â€¢ cass_memory (cm) - Evidence-based learning system"
      echo "  â€¢ beads CLI (bd) - Task tracking"
      echo "  â€¢ beads viewer (bv) - Terminal UI for browsing tasks"
      echo "  â€¢ osgrep - Semantic code search"
      echo "  â€¢ Configures PATH for ~/.config/opencode/bin"
      echo ""
      echo "Usage: opencode-init [--quiet]"
      exit 0
      ;;
    --quiet|-q)
      QUIET=true
      shift
      ;;
  esac
done

# Banner
if [ "$QUIET" = false ]; then
  echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${BLUE}â•‘   OpenCode - System-Wide Setup (opencode-init)â•‘${NC}"
  echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo
  echo -e "${BLUE}ğŸ“‹ System Information:${NC}"
  echo "  OS:        $(uname -s)"
  echo "  Shell:     $SHELL_NAME"
  echo "  Config:    $SHELL_CONFIG"
  echo
fi

# Check prerequisites
echo -e "${BLUE}ğŸ“Š Checking Prerequisites:${NC}"

HAS_GO=false
HAS_NODE=false
PATH_CONFIGURED=false
HAS_CM=false
HAS_BD=false
HAS_OSGREP=false
HAS_BV=false

command -v go &> /dev/null && HAS_GO=true
command -v node &> /dev/null && HAS_NODE=true
command -v npm &> /dev/null && HAS_NODE=true
echo -e "  Go:        $([ "$HAS_GO" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${RED}âœ—${NC}") $(go version 2>/dev/null | head -1 || echo "not installed")"
echo -e "  Node.js:   $([ "$HAS_NODE" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${RED}âœ—${NC}") $(node --version 2>/dev/null || echo "not installed")"

# Check PATH configuration
if [[ ":$PATH:" == *":$HOME/.config/opencode/bin:"* ]]; then
  PATH_CONFIGURED=true
fi
echo -e "  PATH:      $([ "$PATH_CONFIGURED" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") ~/.config/opencode/bin"

# Check tools already installed
command -v cm &> /dev/null && HAS_CM=true
command -v bd &> /dev/null && HAS_BD=true
command -v osgrep &> /dev/null && HAS_OSGREP=true
command -v bv &> /dev/null && HAS_BV=true

echo
echo -e "${BLUE}ğŸ“Š Current Status:${NC}"
echo -e "  cass_memory (cm): $([ "$HAS_CM" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(cm --version 2>/dev/null || echo "not installed")"
echo -e "  Beads CLI (bd):    $([ "$HAS_BD" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(bd --version 2>/dev/null | head -1 || echo "not installed")"
echo -e "  Osgrep:            $([ "$HAS_OSGREP" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(osgrep --version 2>/dev/null || echo "not installed")"
echo -e "  Beads Viewer (bv): $([ "$HAS_BV" = true ] && echo -e "${GREEN}âœ“${NC}" || echo -e "${YELLOW}â—‹${NC}") $(bv --version 2>/dev/null || echo "not installed")"

# Exit if everything is set up
if [ "$PATH_CONFIGURED" = true ] && [ "$HAS_CM" = true ] && [ "$HAS_BD" = true ] && [ "$HAS_OSGREP" = true ] && [ "$HAS_BV" = true ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${GREEN}âœ“ All tools already installed and configured!${NC}"
  fi
  exit 0
fi

# Non-interactive check
if [ ! -t 0 ] && [ "$QUIET" = false ]; then
  echo
  echo -e "${YELLOW}â„¹${NC}  Non-interactive terminal detected"
  echo "  Run with --quiet flag for automated setup"
  exit 0
fi

# Ask for confirmation
if [ "$QUIET" = false ]; then
  echo
  echo -en "${YELLOW}â“${NC}  Would you like to set up your opencode environment? [y/N]: "
  read -r response

  if [[ ! "$response" =~ ^[Yy]$ ]]; then
    echo -e "${YELLOW}Skipped${NC}"
    exit 0
  fi
fi

COMPLETED_STEPS=()

# Detect OS for package manager
OS="$(uname -s)"
if [ "$OS" = "Darwin" ]; then
  PACKAGE_MANAGER="homebrew"
elif [ "$OS" = "Linux" ]; then
  if [ -f /etc/os-release ]; then
    . /etc/os-release
    if [ "$ID" = "ubuntu" ] || [ "$ID" = "debian" ]; then
      PACKAGE_MANAGER="apt"
    else
      PACKAGE_MANAGER="unknown"
    fi
  else
    PACKAGE_MANAGER="unknown"
  fi
else
  PACKAGE_MANAGER="unknown"
fi

# Step 1: Configure PATH
if [ "$PATH_CONFIGURED" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 1: Configure PATH${NC}"
    echo -n "  Add ~/.config/opencode/bin to $SHELL_CONFIG? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping PATH configuration"
    else
      echo 'export PATH="$HOME/.config/opencode/bin:$PATH"' >> "$SHELL_CONFIG"
      export PATH="$HOME/.config/opencode/bin:$PATH"
      echo -e "  ${GREEN}âœ“${NC} Added to $SHELL_CONFIG"
      echo -e "  ${YELLOW}âš ï¸${NC}  Run 'source $SHELL_CONFIG' or start a new terminal to apply changes"
      COMPLETED_STEPS+=("PATH configured")
      PATH_CONFIGURED=true
    fi
  else
    echo 'export PATH="$HOME/.config/opencode/bin:$PATH"' >> "$SHELL_CONFIG"
    export PATH="$HOME/.config/opencode/bin:$PATH"
    COMPLETED_STEPS+=("PATH configured")
    PATH_CONFIGURED=true
  fi
fi

# Step 2: Install Go (if needed)
if [ "$HAS_GO" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 2: Install Go${NC}"
    if [ "$PACKAGE_MANAGER" = "homebrew" ]; then
      echo "  OS detected: macOS"
      echo "  This will run: brew install go"
      echo -n "  Install Go via Homebrew? [Y/n]: "
      read -r r
      if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
        echo "  Skipping Go installation"
        echo -e "  ${RED}âœ—${NC} Go is required for Beads CLI"
        echo "  Install Go from: https://golang.org/dl/"
        exit 1
      else
        brew install go
        echo -e "  ${GREEN}âœ“${NC} Go installed: $(go version)"
        COMPLETED_STEPS+=("Go installed")
        HAS_GO=true
      fi
    elif [ "$PACKAGE_MANAGER" = "apt" ]; then
      echo "  OS detected: Ubuntu/Debian"
      echo "  This will run: sudo apt-get update && sudo apt-get install -y golang-go"
      echo -n "  Install Go via apt? [Y/n]: "
      read -r r
      if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
        echo "  Skipping Go installation"
        echo -e "  ${RED}âœ—${NC} Go is required for Beads CLI"
        echo "  Install Go from: https://golang.org/dl/"
        exit 1
      else
        sudo apt-get update
        sudo apt-get install -y golang-go
        echo -e "  ${GREEN}âœ“${NC} Go installed: $(go version)"
        COMPLETED_STEPS+=("Go installed")
        HAS_GO=true
      fi
    else
      echo -e "  ${RED}âœ—${NC} Go not found"
      echo "  Unsupported OS/package manager: $PACKAGE_MANAGER"
      echo "  Install Go from: https://golang.org/dl/"
      exit 1
    fi
  else
    # Quiet mode - auto-install Go
    if [ "$PACKAGE_MANAGER" = "homebrew" ]; then
      brew install go
      COMPLETED_STEPS+=("Go installed")
      HAS_GO=true
    elif [ "$PACKAGE_MANAGER" = "apt" ]; then
      sudo apt-get update
      sudo apt-get install -y golang-go
      COMPLETED_STEPS+=("Go installed")
      HAS_GO=true
    else
      echo -e "  ${RED}âœ—${NC} Go not found and cannot auto-install on this OS"
      exit 1
    fi
  fi
fi

# Step 3: Install cass_memory (cm)
if [ "$HAS_CM" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 3: Install cass_memory (cm)${NC}"
    echo "  This will run: curl -fsSL https://raw.githubusercontent.com/Dicklesworthstone/cass_memory_system/main/install.sh | bash -s -- --easy-mode --verify"
    echo -n "  Install cass_memory? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping cass_memory installation"
      echo -e "  ${RED}âœ—${NC} cass_memory is required for opencode"
      exit 1
    else
      curl -fsSL https://raw.githubusercontent.com/Dicklesworthstone/cass_memory_system/main/install.sh | bash -s -- --easy-mode --verify

      if command -v cm &> /dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Installed: $(cm --version 2>/dev/null || echo "cm")"
        COMPLETED_STEPS+=("cass_memory installed")
        HAS_CM=true
      else
        echo -e "  ${RED}âœ—${NC} Installation failed"
        exit 1
      fi
    fi
  else
    curl -fsSL https://raw.githubusercontent.com/Dicklesworthstone/cass_memory_system/main/install.sh | bash -s -- --easy-mode --verify
    if command -v cm &> /dev/null; then
      COMPLETED_STEPS+=("cass_memory installed")
      HAS_CM=true
    else
      echo -e "  ${RED}âœ—${NC} cass_memory installation failed"
      exit 1
    fi
  fi
fi

# Step 4: Install beads CLI
if [ "$HAS_BD" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 4: Install Beads CLI${NC}"
    if [ "$HAS_GO" = false ]; then
      echo -e "  ${RED}âœ—${NC} Go not found"
      echo "  Install Go from: https://golang.org/dl/"
      exit 1
    fi
    echo "  This will run: go install github.com/steveyegge/beads/cmd/bd@latest"
    echo -n "  Install beads CLI? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping beads installation"
    else
      go install github.com/steveyegge/beads/cmd/bd@latest

      # Add go/bin to PATH if not already there
      if [[ ":$PATH:" != *":$HOME/go/bin:"* ]]; then
        echo 'export PATH="$HOME/go/bin:$PATH"' >> "$SHELL_CONFIG"
        export PATH="$HOME/go/bin:$PATH"
      fi

      if command -v bd &> /dev/null; then
        BD_VERSION=$(bd --version 2>&1 | head -1)
        echo -e "  ${GREEN}âœ“${NC} Installed: $BD_VERSION"
        COMPLETED_STEPS+=("Beads CLI installed")
        HAS_BD=true
      else
        echo -e "  ${RED}âœ—${NC} Installation failed. Check that \$HOME/go/bin is in PATH"
        exit 1
      fi
    fi
  else
    go install github.com/steveyegge/beads/cmd/bd@latest
    if [[ ":$PATH:" != *":$HOME/go/bin:"* ]]; then
      echo 'export PATH="$HOME/go/bin:$PATH"' >> "$SHELL_CONFIG"
      export PATH="$HOME/go/bin:$PATH"
    fi
    COMPLETED_STEPS+=("Beads CLI installed")
    HAS_BD=true
  fi
fi

# Step 5: Install osgrep
if [ "$HAS_OSGREP" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 5: Install Osgrep (Semantic Search)${NC}"
    if [ "$HAS_NODE" = false ]; then
      echo -e "  ${RED}âœ—${NC} Node.js not found"
      echo "  Install Node.js from: https://nodejs.org/"
      exit 1
    fi
    echo "  This will run: npm install -g osgrep"
    echo "  (Downloads ~150MB of embedding models)"
    echo -n "  Install osgrep? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping osgrep installation"
    else
      npm install -g osgrep

      if command -v osgrep &> /dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Installed: $(osgrep --version)"
        COMPLETED_STEPS+=("Osgrep installed")
        HAS_OSGREP=true

        # Optionally run osgrep setup to download models
        if [ "$QUIET" = false ]; then
          echo
          echo -n "  Download embedding models now (~150MB)? [Y/n]: "
          read -r m
          if [[ -z "$m" ]] || [[ "$m" =~ ^[Yy]$ ]]; then
            echo "  Downloading models..."
            osgrep setup
            echo -e "  ${GREEN}âœ“${NC} Models downloaded"
          else
            echo "  Run 'osgrep setup' later to download models"
          fi
        fi
      else
        echo -e "  ${RED}âœ—${NC} Installation failed"
        exit 1
      fi
    fi
  else
    npm install -g osgrep
    COMPLETED_STEPS+=("Osgrep installed")
    HAS_OSGREP=true
  fi
fi

# Step 6: Install beads viewer (bv)
if [ "$HAS_BV" = false ]; then
  if [ "$QUIET" = false ]; then
    echo
    echo -e "${BLUE}Step 6: Install Beads Viewer (Terminal UI)${NC}"
    echo "  This downloads and installs beads viewer from GitHub"
    echo "  Source: https://github.com/Dicklesworthstone/beads_viewer"
    echo -n "  Install beads viewer? [Y/n]: "
    read -r r
    if [[ -n "$r" ]] && [[ ! "$r" =~ ^[Yy]$ ]]; then
      echo "  Skipping beads viewer installation"
    else
      curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/beads_viewer/main/install.sh" | bash

      if command -v bv &> /dev/null; then
        echo -e "  ${GREEN}âœ“${NC} Installed: $(bv --version 2>/dev/null || echo "bv")"
        COMPLETED_STEPS+=("Beads Viewer installed")
        HAS_BV=true
      else
        echo -e "  ${YELLOW}âš ï¸${NC}  Installation may have failed. Check ~/.local/bin"
      fi
    fi
  else
    curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/beads_viewer/main/install.sh" | bash
    COMPLETED_STEPS+=("Beads Viewer installed")
    HAS_BV=true
  fi
fi

# Summary
if [ "$QUIET" = false ]; then
  echo
  echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
  echo -e "${BLUE}â•‘   Setup Complete!                                     â•‘${NC}"
  echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
  echo

  if [ ${#COMPLETED_STEPS[@]} -gt 0 ]; then
    echo -e "${GREEN}âœ“ Completed:${NC}"
    for step in "${COMPLETED_STEPS[@]}"; do
      echo "  â€¢ $step"
    done
    echo
  fi

  if [ "$PATH_CONFIGURED" = true ]; then
    echo -e "${YELLOW}âš ï¸${NC}  Important:"
    echo "  Source your shell configuration to apply PATH changes:"
    echo "    source $SHELL_CONFIG"
    echo "  Or start a new terminal window"
    echo
  fi

  echo -e "${BLUE}Next Steps:${NC}"
  echo "  1. Source your shell config or start a new terminal"
  echo "  2. Run 'workspace-init' in your project directory to set up task tracking"
  echo "  3. Run 'osgrep setup' if you didn't download models yet"
  echo
  echo -e "${BLUE}Quick Start:${NC}"
  echo "  cd /path/to/your/project"
  echo "  workspace-init"
  echo
fi

exit 0

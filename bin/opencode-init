#!/bin/bash
# opencode-init - System-wide setup for opencode
# Run this script from ANY directory to install and configure tools

set -e

OPENCODE_DIR="$HOME/.config/opencode"
OPENCODE_BIN="$OPENCODE_DIR/bin"

# Detect shell
if [ -n "$ZSH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.zshrc"
  SHELL_NAME="zsh"
elif [ -n "$BASH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.bashrc"
  SHELL_NAME="bash"
else
  SHELL_CONFIG="$HOME/.profile"
  SHELL_NAME="sh"
fi

# Check if already in PATH
if [[ ":$PATH:" == *":$OPENCODE_BIN:"* ]]; then
  PATH_CONFIGURED=true
else
  PATH_CONFIGURED=false
fi

# Banner
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   OpenCode - System Setup                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Current status:"
echo "  Shell:     $SHELL_NAME"
echo "  Config:    $SHELL_CONFIG"
echo "  PATH configured: $([ "$PATH_CONFIGURED" = true ] && echo 'Yes' || echo 'No')"
echo ""

# Ask if user wants to continue
read -p "Continue with setup? [Y/n]: " CONFIRM

if [[ "$CONFIRM" != "y" && "$CONFIRM" != "Y" ]]; then
  echo "Setup cancelled."
  exit 0
fi

echo ""
echo "ğŸ“‹ Checking tools..."

HAS_CM=false
HAS_BIOME=false
HAS_PRETTIER=false
HAS_BD=false
HAS_BV=false
HAS_GO=false

# Check for Go
if command -v go &> /dev/null; then
  HAS_GO=true
fi

# Check for cass
if command -v cm &> /dev/null; then
  HAS_CM=true
  if command -v cass &> /dev/null; then
    CASS_HEALTHY=$(cm health 2>/dev/null && echo "healthy")
    if [ "$CASS_HEALTHY" = "healthy" ]; then
      echo "  âœ“ cass_memory (cm): healthy"
    else
      echo "  âš  cass_memory (cm): needs attention"
    fi
  fi
fi

# Check for Biome
if command -v biome &> /dev/null; then
  HAS_BIOME=true
  echo "  âœ“ Biome: $(biome --version 2>/dev/null | head -1 || echo 'installed')"
fi

# Check for Prettier
if command -v prettier &> /dev/null; then
  HAS_PRETTIER=true
  echo "  âœ“ Prettier: $(prettier --version 2>/dev/null | head -1 || echo 'installed')"
fi

# Check for Beads CLI
if command -v bd &> /dev/null; then
  HAS_BD=true
  echo "  âœ“ Beads CLI (bd): $(bd --version 2>/dev/null | head -1 || echo 'installed')"
fi

# Check for Beads Viewer
if command -v bv &> /dev/null; then
  HAS_BV=true
  echo "  âœ“ Beads Viewer (bv): $(bv --version 2>/dev/null | head -1 || echo 'installed')"
fi

# Check for osgrep (optional)
if command -v osgrep &> /dev/null; then
  HAS_OSGREP=true
  echo "  âœ“ Osgrep: $(osgrep --version 2>/dev/null | head -1 || echo 'installed')"
fi

# Check for UBS (optional)
if command -v ubs &> /dev/null; then
  HAS_UBS=true
  echo "  âœ“ UBS: $(ubs --version 2>/dev/null | head -1 || echo 'installed')"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Step 1: Install Go if needed (for Beads CLI)
if [ "$HAS_GO" = false ]; then
  echo "Step 1: Installing Go..."
  if [ "$(uname -s)" = "Darwin" ] && command -v brew &> /dev/null; then
    brew install go
  elif [ -f /etc/os-release ]; then
    . /etc/os-release
    if [ "$ID" = "ubuntu" ] || [ "$ID" = "debian" ]; then
      sudo apt-get update
      sudo apt-get install -y golang-go
    fi
  else
    echo "  âš ï¸  Go not found and cannot auto-install on this OS"
    echo "  Install Go from: https://golang.org/dl/"
    exit 1
  fi
  HAS_GO=true
  echo "  âœ“ Go installed: $(go version)"
fi

# Step 2: Install Beads CLI if needed
if [ "$HAS_BD" = false ]; then
  echo "Step 2: Installing Beads CLI (bd)..."
  go install github.com/steveyegge/beads/cmd/bd@latest
  if [ $? -ne 0 ]; then
    echo "  âœ— Failed to install Beads CLI"
    exit 1
  fi
  echo "  âœ“ Beads CLI installed: $(bd --version 2>/dev/null | head -1 || echo 'installed')"
  HAS_BD=true
fi

# Step 3: Install Beads Viewer if needed
if [ "$HAS_BV" = false ]; then
  echo "Step 3: Installing Beads Viewer (bv)..."
  curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/beads_viewer/main/install.sh?$(date +%s)" | bash
  if [ $? -ne 0 ]; then
    echo "  âœ— Failed to install Beads Viewer"
    exit 1
  fi
  echo "  âœ“ Beads Viewer installed: $(bv --version 2>/dev/null | head -1 || echo 'installed')"
  HAS_BV=true
fi

# Step 4: Install Osgrep if needed
if [ "$HAS_OSGREP" = false ]; then
  echo "Step 4: Installing Osgrep..."
  npm install -g @steveyegge/osgrep
  if [ $? -ne 0 ]; then
    echo "  âœ— Failed to install Osgrep"
    exit 1
  fi
  echo "  âœ“ Osgrep installed: $(osgrep --version 2>/dev/null | head -1 || echo 'installed')"
  HAS_OSGREP=true
fi

# Step 5: Install UBS if needed
if [ "$HAS_UBS" = false ]; then
  echo "Step 5: Installing UBS..."
  curl -fsSL "https://raw.githubusercontent.com/Dicklesworthstone/ultimate_bug_scanner/master/install.sh?$(date +%s)" | bash
  if [ $? -ne 0 ]; then
    echo "  âœ— Failed to install UBS"
    exit 1
  fi
  echo "  âœ“ UBS installed: $(ubs --version 2>/dev/null | head -1 || echo 'installed')"
  HAS_UBS=true
fi

# Step 6: Configure PATH
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Step 6: Configuring PATH..."

if [ "$PATH_CONFIGURED" = true ]; then
  echo "  âœ“ PATH already configured in $SHELL_CONFIG"
else
  echo "  Adding to $SHELL_CONFIG: export PATH=\"$OPENCODE_BIN:\$PATH\""
  echo "export PATH=\"$OPENCODE_BIN:\$PATH\"" >> "$SHELL_CONFIG"
  PATH_CONFIGURED=true
  echo "  âœ“ PATH configured"
fi

# Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   Setup Complete!                                    â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ“ Installed:"
echo "  â€¢ cass_memory (cm) - Evidence-based learning system"
echo "  â€¢ Biome - Modern linting and formatting (20+ languages)"
echo "  â€¢ Prettier - Code formatter"
echo "  â€¢ Go - Required for Beads CLI"
echo "  â€¢ Beads CLI (bd) - Task tracking"
echo "  â€¢ Beads Viewer (bv) - Terminal UI for browsing tasks"
echo "  â€¢ Osgrep - Semantic code search"
echo "  â€¢ UBS - Multi-language static analysis"
echo ""
echo "âš ï¸  IMPORTANT: Apply PATH changes to your current shell:"
echo "   source $SHELL_CONFIG"
echo "   Or restart your terminal"
echo ""

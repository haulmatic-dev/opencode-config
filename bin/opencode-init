#!/bin/bash
# opencode-init - System-wide setup for opencode
# Run this script from ANY directory to install and configure tools

set -e

OPENCODE_DIR="$HOME/.config/opencode"
OPENCODE_BIN="$OPENCODE_DIR/bin"

# Detect shell
if [ -n "$ZSH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.zshrc"
elif [ -n "$BASH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.bashrc"
else
  SHELL_CONFIG="$HOME/.profile"
fi

# Check if PATH is already configured
PATH_CONFIGURED=false
if [[ ":$PATH:" == *":$OPENCODE_BIN:"* ]]; then
  PATH_CONFIGURED=true
fi

# Banner
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   OpenCode - System Setup                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“‹ Current Status:"
echo ""
echo "  Shell:     $(basename $SHELL_CONFIG)"
echo "  Config:    $SHELL_CONFIG"
echo "  PATH configured: $([ "$PATH_CONFIGURED" = true ] && echo 'Yes' || echo 'No')"
echo ""

# Check tool status
HAS_GO=false
HAS_CM=false
HAS_BIOME=false
HAS_PRETTIER=false
HAS_BD=false
HAS_BV=false
HAS_OSGREP=false
HAS_UBS=false

# Check for Go
if command -v go &> /dev/null; then
  HAS_GO=true
  echo "  Go: âœ“"
else
  echo "  Go: â—‹ (needed for Beads CLI)"
fi

# Check for cass
if command -v cm &> /dev/null; then
  HAS_CM=true
  if command -v cass &> /dev/null; then
    CASS_HEALTHY=$(cm health 2>/dev/null && echo "healthy")
    
    if [ "$CASS_HEALTHY" = "healthy" ]; then
      if ! pgrep -f "cass" > /dev/null 2>&1; then
        echo "  cass_memory (cm): âœ“ (healthy)"
      else
        echo "  cass_memory (cm): âœ“ (running)"
      fi
    else
      echo "  cass_memory (cm): â—‹ (needs health check)"
    fi
else
  echo "  cass_memory (cm): â—‹ (not installed)"
fi

# Check for Biome
if command -v biome &> /dev/null; then
  HAS_BIOME=true
  echo "  Biome: âœ“ $(biome --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Biome: â—‹ (not installed)"
fi

# Check for Prettier
if command -v prettier &> /dev/null; then
  HAS_PRETTIER=true
  echo "  Prettier: âœ“ $(prettier --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Prettier: â—‹ (not installed)"
fi

# Check for Beads CLI
if command -v bd &> /dev/null; then
  HAS_BD=true
  echo "  Beads CLI (bd): âœ“ $(bd --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Beads CLI (bd): â—‹ (not installed)"
fi

# Check for Beads Viewer
if command -v bv &> /dev/null; then
  HAS_BV=true
  echo "  Beads Viewer (bv): âœ“ $(bv --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Beads Viewer (bv): â—‹ (not installed)"
fi

# Check for osgrep (optional)
if command -v osgrep &> /dev/null; then
  HAS_OSGREP=true
  echo "  Osgrep: âœ“ $(osgrep --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Osgrep: â—‹ (not installed)"
fi

# Check for UBS (optional)
if command -v ubs &> /dev/null; then
  HAS_UBS=true
  echo "  UBS: âœ“ $(ubs --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  UBS: â—‹ (not installed)"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Count tools that need to be installed
MISSING_COUNT=0
[ "$HAS_GO" = false ] && ((MISSING_COUNT++))
[ "$HAS_BIOME" = false ] && ((MISSING_COUNT++))
[ "$HAS_PRETTIER" = false ] && ((MISSING_COUNT++))
[ "$HAS_BD" = false ] && ((MISSING_COUNT++))
[ "$HAS_BV" = false ] && ((MISSING_COUNT++))
[ "$HAS_OSGREP" = false ] && ((MISSING_COUNT++))
[ "$HAS_UBS" = false ] && ((MISSING_COUNT++))

if [ $MISSING_COUNT -eq 0 ]; then
  echo ""
  echo "âœ“ All tools are already installed and configured!"
  echo ""
  echo "What would you like to do?"
  echo ""
  echo "  1) Exit - Keep current configuration"
  echo "  2) Reconfigure PATH - Ensure $OPENCODE_BIN is in PATH"
  echo "  3) Exit and source config - Source $SHELL_CONFIG to apply PATH"
  echo ""
  read -p "Select option [1/2/3]: " CHOICE
  
  case "$CHOICE" in
    1)
      echo "Exiting..."
      ;;
    2)
      # Reconfigure PATH
      echo ""
      echo "Adding $OPENCODE_BIN to PATH..."
      echo "export PATH=\"$OPENCODE_BIN:\$PATH\"" >> "$SHELL_CONFIG"
      echo "âœ“ PATH configured"
      PATH_CONFIGURED=true
      echo ""
      echo "âš ï¸  IMPORTANT: Source your shell config to apply PATH:"
      echo "  source $SHELL_CONFIG"
      echo "  Or restart your terminal."
      ;;
    3)
      echo "Exiting..."
      echo ""
      echo "âš ï¸  Don't forget to source your shell config to apply PATH:"
      echo "  source $SHELL_CONFIG"
      ;;
  esac
else
  echo ""
  echo "Found $MISSING_COUNT missing tool(s) that need installation."
  echo ""
  
  # Install Go if needed
  if [ "$HAS_GO" = false ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 1: Install Go (required for Beads CLI)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    OS="$(uname -s)"
    if [ "$OS" = "Darwin" ]; then
      PACKAGE_MANAGER="homebrew"
    elif [ -f /etc/os-release ]; then
      . /etc/os-release
      if [ "$ID" = "ubuntu" ] || [ "$ID" = "debian" ]; then
        PACKAGE_MANAGER="apt"
      else
        PACKAGE_MANAGER="unknown"
      fi
    else
      PACKAGE_MANAGER="unknown"
    fi
    
    if [ "$PACKAGE_MANAGER" = "homebrew" ]; then
      brew install go
      if [ $? -ne 0 ]; then
        echo "âœ— Failed to install Go"
        exit 1
      fi
    elif [ "$PACKAGE_MANAGER" = "apt" ]; then
      sudo apt-get update
      sudo apt-get install -y golang-go
      if [ $? -ne 0 ]; then
        echo "âœ— Failed to install Go"
        exit 1
      fi
    else
      echo "âš ï¸  Go not found and cannot auto-install on this OS"
      echo "   Install Go from: https://golang.org/dl/"
      echo ""
      read -p "Press Enter to continue..." && read
    fi
    HAS_GO=true
    echo "âœ“ Go installed"
  fi
  
  # Install Biome if missing
  if [ "$HAS_BIOME" = false ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 2: Install Biome"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    npm install -g @biomejs/biome
    if [ $? -ne 0 ]; then
      echo "âœ— Failed to install Biome"
      exit 1
    fi
    echo "âœ“ Biome installed"
    HAS_BIOME=true
  fi
  
  # Install Prettier if missing
  if [ "$HAS_PRETTIER" = false ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 3: Install Prettier"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    npm install -g prettier
    if [ $? -ne 0 ]; then
      echo "âœ— Failed to install Prettier"
      exit 1
    fi
    echo "âœ“ Prettier installed"
    HAS_PRETTIER=true
  fi
  
  # Install Beads CLI if missing
  if [ "$HAS_BD" = false ] && [ "$HAS_GO" = true ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 4: Install Beads CLI (bd)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”:
    - When tools are installed, offer options to (1) Exit (2) Reconfigure PATH (3) Exit and source config
    - Always install missing tools, then always configure PATH at the end
    - Show clear next-step to apply PATH changes"
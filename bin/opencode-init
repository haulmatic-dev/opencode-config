#!/bin/bash
# opencode-init - System-wide setup for opencode
# Run this script from ANY directory to install and configure tools

set -e

OPENCODE_DIR="$HOME/.config/opencode"
OPENCODE_BIN="$OPENCODE_DIR/bin"

# Detect shell
if [ -n "$ZSH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.zshrc"
elif [ -n "$BASH_VERSION" ]; then
  SHELL_CONFIG="$HOME/.bashrc"
else
  SHELL_CONFIG="$HOME/.profile"
fi

# Check if PATH is already configured
PATH_CONFIGURED=false
if [[ ":$PATH:" == *":$OPENCODE_BIN:"* ]]; then
  PATH_CONFIGURED=true
fi

# Banner
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   OpenCode - System Setup                              â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“‹ Current Status:"
echo ""
echo "  Shell:     $(basename $SHELL_CONFIG)"
echo "  Config:    $SHELL_CONFIG"
echo "  PATH configured: $([ "$PATH_CONFIGURED" = true ] && echo 'Yes' || echo 'No')"
echo ""

# Check tool status
HAS_GO=false
HAS_CM=false
HAS_BIOME=false
HAS_PRETTIER=false
HAS_BD=false
HAS_BV=false
HAS_TLDR=false
HAS_TLDR_DAEMON=false
HAS_UBS=false

# Check for Go
if command -v go &> /dev/null; then
  HAS_GO=true
  echo "  Go: âœ“"
else
  echo "  Go: â—‹ (needed for Beads CLI)"
fi

# Check for cass_memory
if command -v cm &> /dev/null; then
  HAS_CM=true
  if pgrep -f "cass" > /dev/null 2>&1; then
    echo "  cass_memory (cm): âœ“ (running)"
  else
    echo "  cass_memory (cm): âœ“ (installed, not running)"
  fi
else
  echo "  cass_memory (cm): â—‹ (not installed)"
fi

# Check for Biome
if command -v biome &> /dev/null; then
  HAS_BIOME=true
  echo "  Biome: âœ“ $(biome --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Biome: â—‹ (not installed)"
fi

# Check for Prettier
if command -v prettier &> /dev/null; then
  HAS_PRETTIER=true
  echo "  Prettier: âœ“ $(prettier --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Prettier: â—‹ (not installed)"
fi

# Check for Beads CLI
if command -v bd &> /dev/null; then
  HAS_BD=true
  echo "  Beads CLI (bd): âœ“ $(bd --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Beads CLI (bd): â—‹ (not installed)"
fi

# Check for Beads Viewer
if command -v bv &> /dev/null; then
  HAS_BV=true
  echo "  Beads Viewer (bv): âœ“ $(bv --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  Beads Viewer (bv): â—‹ (not installed)"
fi

# Check for TLDR (Python package)
if command -v tldr &> /dev/null; then
  HAS_TLDR=true
  # Check if daemon is running (with timeout)
  if timeout 5 tldr daemon status 2>&1 | grep -q "running\|ready"; then
    HAS_TLDR_DAEMON=true
    echo "  TLDR: âœ“ (daemon running)"
  else
    echo "  TLDR: âœ“ (installed, daemon not running)"
  fi
else
  echo "  TLDR: â—‹ (not installed - required for semantic search)"
fi

# Check for UBS (optional)
if command -v ubs &> /dev/null; then
  HAS_UBS=true
  echo "  UBS: âœ“ $(ubs --version 2>/dev/null | head -1 || echo 'unknown')"
else
  echo "  UBS: â—‹ (optional - for static analysis)"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Count tools that need to be installed (excluding TLDR - handled separately)
MISSING_COUNT=0
[ "$HAS_GO" = false ] && ((MISSING_COUNT++))
[ "$HAS_BIOME" = false ] && ((MISSING_COUNT++))
[ "$HAS_PRETTIER" = false ] && ((MISSING_COUNT++))
[ "$HAS_BD" = false ] && ((MISSING_COUNT++))
[ "$HAS_BV" = false ] && ((MISSING_COUNT++))
[ "$HAS_UBS" = false ] && ((MISSING_COUNT++))

# Check if TLDR needs setup
TLDR_NEEDS_SETUP=false
if [ "$HAS_TLDR" = false ]; then
  TLDR_NEEDS_SETUP="install"
elif [ "$HAS_TLDR_DAEMON" = false ]; then
  TLDR_NEEDS_SETUP="start"
fi

if [ $MISSING_COUNT -eq 0 ] && [ "$TLDR_NEEDS_SETUP" = false ]; then
  echo ""
  echo "âœ“ All tools are already installed and configured!"
  echo ""
  echo "What would you like to do?"
  echo ""
  echo "  1) Exit - Keep current configuration"
  echo "  2) Reconfigure PATH - Ensure $OPENCODE_BIN is in PATH"
  echo "  3) Exit and source config - Source $SHELL_CONFIG to apply PATH"
  echo ""
  read -p "Select option [1/2/3]: " CHOICE
  
  case "$CHOICE" in
    1)
      echo "Exiting..."
      ;;
    2)
      echo ""
      echo "Adding $OPENCODE_BIN to PATH..."
      echo "export PATH=\"$OPENCODE_BIN:\$PATH\"" >> "$SHELL_CONFIG"
      echo "âœ“ PATH configured"
      PATH_CONFIGURED=true
      echo ""
      echo "âš ï¸  IMPORTANT: Source your shell config to apply PATH:"
      echo "  source $SHELL_CONFIG"
      echo "  Or restart your terminal."
      ;;
    3)
      echo "Exiting..."
      echo ""
      echo "âš ï¸  Don't forget to source your shell config to apply PATH:"
      echo "  source $SHELL_CONFIG"
      ;;
  esac
else
  echo ""
  TOTAL_NEEDS=$MISSING_COUNT
  [ "$TLDR_NEEDS_SETUP" != false ] && ((TOTAL_NEEDS++))
  echo "Found $TOTAL_NEEDS item(s) that need attention."
  echo ""
  
  # Handle TLDR first if needed
  if [ "$TLDR_NEEDS_SETUP" = "install" ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Setting up TLDR (required for semantic search)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Check for Python 3.11+
    PYTHON_VERSION=$(python3 --version 2>/dev/null | awk '{print $2}' || echo "0.0")
    PYTHON_MAJOR=$(echo $PYTHON_VERSION | cut -d. -f1)
    PYTHON_MINOR=$(echo $PYTHON_VERSION | cut -d. -f2)
    
    if [ "$PYTHON_MAJOR" -eq 3 ] && [ "$PYTHON_MINOR" -ge 11 ] 2>/dev/null; then
      echo "  Python 3.11+ found: $PYTHON_VERSION"
    else
      echo "  Python 3.11+ required for TLDR"
      echo "  Installing Python 3.11 via pyenv..."
      
      if command -v pyenv &> /dev/null; then
        pyenv install 3.11.0 2>/dev/null || echo "  Note: Python 3.11 installation may require manual setup"
      else
        echo "  âš ï¸  pyenv not found. Please install Python 3.11 manually:"
        echo "      brew install pyenv && pyenv install 3.11.0"
      fi
    fi
    
    echo ""
    echo "  Installing TLDR..."
    pip install llm-tldr 2>/dev/null || python3 -m pip install llm-tldr 2>/dev/null || echo "  Note: Manual installation may be needed"
    
    echo ""
    echo "  Indexing project for faster queries..."
    if [ -d "$OPENCODE_DIR" ]; then
      cd "$OPENCODE_DIR" && tldr warm . 2>/dev/null || echo "  Note: Run 'tldr warm .' manually in opencode directory"
    fi
    
    HAS_TLDR=true
    echo "âœ“ TLDR installed"
    echo ""
  elif [ "$TLDR_NEEDS_SETUP" = "start" ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Starting TLDR daemon"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    if [ -d "$OPENCODE_DIR" ]; then
      cd "$OPENCODE_DIR" && tldr daemon start 2>/dev/null || echo "  Note: Run 'tldr daemon start' manually"
      HAS_TLDR_DAEMON=true
      echo "âœ“ TLDR daemon started"
    else
      echo "  Note: opencode directory not found at $OPENCODE_DIR"
    fi
    echo ""
  fi
  
  # Install Go if needed
  if [ "$HAS_GO" = false ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 1: Install Go (required for Beads CLI)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    OS="$(uname -s)"
    if [ "$OS" = "Darwin" ]; then
      brew install go
    elif [ "$OS" = "Linux" ]; then
      if [ -f /etc/os-release ]; then
        . /etc/os-release
        if [ "$ID" = "ubuntu" ] || [ "$ID" = "debian" ]; then
          sudo apt-get update && sudo apt-get install -y golang-go
        fi
      fi
    fi
    
    if command -v go &> /dev/null; then
      HAS_GO=true
      echo "âœ“ Go installed"
    else
      echo "âš ï¸  Go installation failed. Install manually: https://golang.org/dl/"
    fi
    echo ""
  fi
  
  # Install Biome if missing
  if [ "$HAS_BIOME" = false ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 2: Install Biome"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    npm install -g @biomejs/biome
    if [ $? -eq 0 ]; then
      HAS_BIOME=true
      echo "âœ“ Biome installed"
    else
      echo "âœ— Failed to install Biome"
    fi
    echo ""
  fi
  
  # Install Prettier if missing
  if [ "$HAS_PRETTIER" = false ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 3: Install Prettier"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    npm install -g prettier
    if [ $? -eq 0 ]; then
      HAS_PRETTIER=true
      echo "âœ“ Prettier installed"
    else
      echo "âœ— Failed to install Prettier"
    fi
    echo ""
  fi
  
  # Install Beads CLI if missing
  if [ "$HAS_BD" = false ] && [ "$HAS_GO" = true ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 4: Install Beads CLI (bd)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    go install github.com/anomalyco/beads/cmd/bd@latest 2>/dev/null || \
    go install github.com/anomalyco/beads/cmd/bd@v0.1.0 2>/dev/null || {
      echo "âš ï¸  Beads CLI installation failed"
      echo "   Try: go install github.com/anomalyco/beads/cmd/bd@latest"
    }
    if [ -d "$HOME/go/bin" ] && [[ ":$PATH:" != *":$HOME/go/bin:"* ]]; then
      echo "export PATH=\"\$HOME/go/bin:\$PATH\"" >> "$SHELL_CONFIG"
    fi
    HAS_BD=true
    echo "âœ“ Beads CLI installed"
    echo ""
  fi
  
  # Install UBS if missing (optional)
  if [ "$HAS_UBS" = false ]; then
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Step 5: Install UBS (Ultimate Bug Scanner) - Optional"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  âš ï¸  UBS installation skipped (optional)"
    echo "  Install later: https://github.com/anomalyco/ubs"
    HAS_UBS=true
    echo ""
  fi
  
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ“ Setup complete!"
  echo ""
  echo "ğŸ“ Next steps:"
  echo ""
  
  REMAINING=""
  
  if [ "$HAS_TLDR" = true ] && [ "$HAS_TLDR_DAEMON" = false ]; then
    REMAINING="${REMAINING}  - Start TLDR daemon: cd $OPENCODE_DIR && tldr daemon start\n"
  fi
  
  if [ "$PATH_CONFIGURED" = false ]; then
    REMAINING="${REMAINING}  - Source shell config: source $SHELL_CONFIG\n"
  fi
  
  if [ -n "$REMAINING" ]; then
    echo -e "$REMAINING"
  fi
  
  echo "  - Start opencode: cd $OPENCODE_DIR && npm run dev"
  echo ""
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

#!/bin/bash
# Pre-commit hook for UBS (Ultimate Bug Scanner)
# Blocks commits with critical bugs

set -e

echo "ğŸ”¬ Running UBS static analysis..."

# Get staged files
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | tr '\n' ' ')

if [ -z "$CHANGED_FILES" ]; then
    echo "No files staged for commit"
    exit 0
fi

# Check if UBS is installed
if ! command -v ubs &> /dev/null; then
    echo "âš ï¸  UBS not installed. Skipping static analysis."
    echo "   To install: curl -fsSL \"https://raw.githubusercontent.com/Dicklesworthstone/ultimate_bug_scanner/master/install.sh?\$(date +%s)\" | bash"
    exit 0
fi

# Filter to UBS-supported files
UBS_FILES=""
for file in $CHANGED_FILES; do
    ext="${file##*.}"
    case "$ext" in
        js|jsx|ts|tsx|mjs|cjs|py|pyw|pyi|c|cc|cpp|cxx|h|hh|hpp|hxx|rs|go|java|rb)
            UBS_FILES="$UBS_FILES $file"
            ;;
    esac
done

if [ -z "$UBS_FILES" ]; then
    echo "No UBS-supported files changed"
    exit 0
fi

echo "Scanning files: $UBS_FILES"

# Run UBS on staged files
if ! ubs $UBS_FILES --fail-on-warning 2>&1 | tee /tmp/ubs-output.txt; then
    echo ""
    echo "âŒ Critical issues found by UBS. Fix them or use: git commit --no-verify"
    echo ""
    echo "Top issues:"
    grep -A 3 "ğŸ”¥ CRITICAL" /tmp/ubs-output.txt | head -20 || true
    exit 1
fi

echo "âœ… UBS quality check passed - committing..."
exit 0